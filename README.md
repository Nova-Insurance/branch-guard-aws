- [üîê Branch Guard](#-branch-guard)
- [üìé  Prerequisites](#--prerequisites)
- [üöÄ Usage](#-usage)
  - [üñ•Ô∏è  Local Development](#Ô∏è--local-development)
    - [Ngrok Configuration](#ngrok-configuration)
    - [Github Webhook Configuration](#github-webhook-configuration)
  - [‚ö°Ô∏è Serverless Deployment (Azure Functions)](#Ô∏è-serverless-deployment-azure-functions)
  - [‚öôÔ∏è Github Workflow Configuration (Automate deployments)](#Ô∏è-github-workflow-configuration-automate-deployments)
  - [‚úâÔ∏è Response codes](#Ô∏è-response-codes)
- [üìñ Readings \& References](#-readings--references)
- [‚ù§Ô∏è Future Enhancements](#Ô∏è-future-enhancements)
  - [License](#license)


# üîê Branch Guard

A GitHub project for automating repository management tasks and ensuring security through webhooks and Azure Functions.

# üìé  Prerequisites

- Node.js > 20.7.0 installed on your machine
- Ngrok installed on your machine (for testing locally)
- GitHub API Key with the following permissions:
  - Read and Write access to administration and issues
  - Read access to metadata
- A GitHub Organisation (you can create one for free)
- Active Azure Account with the following extensions installed in your IDE:
  - Azure Account
  - Azure Functions
  - Azure Resources

# üöÄ Usage

## üñ•Ô∏è  Local Development

When starting the app locally, Github webhook has no visibility of your localhost machine. We will install and use `ngrok` to publish a public proxy url of your localhost to the internet. The steps are outline below. This setup is only required locally and can be ignored when deploying to Azure Functions. 

![Alt text](/local.png)

1. **Clone the repository**
   ```bash
   git clone https://github.com/your_username/branch-guard.git
   ```

2. **Rename .env.example file to .env and update `GITHUB_API_KEY`**
   ```bash
   GITHUB_API_KEY=<your_github_key>
   ```

3. **Install Azure Core Tools and Functions extensions**
   
4. **Install dependencies**
   ```bash
   npm install
   ```

5. **Start the function**
   ```bash
   func start
   ```
   The application will be accessible at: [http://localhost:7071/repository/lock](http://localhost:7071/repository/lock)

6. **Perform a Ping test**
   ```bash
   curl -X POST http://localhost:7071/repository/lock
   ```

### Ngrok Configuration ###

1. **Start tunnel**
   ```bash
   ngrok http 7071
   Ngrok started at: https://abc.ngrok-free.app/repository/lock
   ```   

### Github Webhook Configuration ###

1. Create Organisation: `ABC` > Settings > Add webhook.
   
2. Subscribe for 'Repository Create / Update' events.
   
3. Add URL `https://abc.ngrok-free.app/repository/lock`.
   
4. Create a new repository to verify the app works locally.
   
5. An issue will be created tagging `@nanospeck`.
   
6. The main branch will be protected.

7. Logs will be printed locally.

## ‚ö°Ô∏è Serverless Deployment (Azure Functions)

![Alt text](/cloud.png)

1. Login to Azure account in VS Code.

2. Create Function App in Azure.

3. Right-click on the Function App > Deploy to Function App > Choose the function app created in the previous step.

4. Go to Azure Resources > Function App > Choose your App > Application Settings and add the `GITHUB_API_KEY`.
5. **IMPORTANT**: Update the Github webhook url with the new function url generated by Azure functions.

## ‚öôÔ∏è Github Workflow Configuration (Automate deployments)

1. Select the function app's **Overview** page, and then select **Get publish profile**.

2. Go to Github > Repository > Settings > Secrets and variables > Actions.

3. Select new repository secret.

4. Add a new secret with the name `AZURE_FUNCTIONAPP_PUBLISH_PROFILE` and the value set to the contents of the publishing profile file.

5. Select Add secret.

6. GitHub can now authenticate to your function app in Azure.

7. Update the `.yml` file in `.github/workflows` with Application name.

8. Push the code to Github and verify that the deployments are now automatically pushed to Azure.

For more reference, check out [Microsoft Azure Functions GitHub Actions guide](https://learn.microsoft.com/en-us/azure/azure-functions/functions-how-to-github-actions?tabs=windows%2Cjavascript&pivots=method-manual#example-workflow-configuration-file).


## ‚úâÔ∏è Response codes

| Response code | Meaning                                       |
|---------------|-----------------------------------------------|
| 202           | Accepted for processing                       |
| 400           | Bad request (eg. GET request instead of POST) |


# üìñ Readings & References #

- [Refer the API Documentation from Github and create a sample application](https://docs.github.com/en/webhooks/using-webhooks/handling-webhook-deliveries#javascript-example)

- [Track repository creation events using Github webhook](https://docs.github.com/en/webhooks/webhook-events-and-payloads?actionType=created#repository)

- [Reading about octokit library](https://github.com/octokit/octokit.js/#readme)

- [Reading about Admin branch protection](https://docs.github.com/en/rest/branches/branch-protection?apiVersion=2022-11-28#set-admin-branch-protection)

- [Find relevant token permission (Administration) for enforcing {branch}/protection/enforce_admins](https://docs.github.com/en/rest/overview/permissions-required-for-fine-grained-personal-access-tokens?apiVersion=2022-11-28#repository-permissions-for-administration)

- [Protect a branch using Github API](https://docs.github.com/en/rest/branches/branch-protection?apiVersion=2022-11-28#update-branch-protection)

- [Create an Issue using GitHub API](https://docs.github.com/en/rest/issues/issues?apiVersion=2022-11-28#create-an-issue)

- [Azure Functions (Serverless)](https://learn.microsoft.com/en-us/azure/azure-functions/functions-reference-node?tabs=javascript%2Cwindows%2Cazure-cli&pivots=nodejs-model-v4)

- [Configuring Github Actions](https://learn.microsoft.com/en-us/azure/azure-functions/functions-how-to-github-actions?tabs=windows%2Cjavascript&pivots=method-manual#example-workflow-configuration-file)

# ‚ù§Ô∏è Future Enhancements #

- Function: Create github issue if there was a failure to protect the branch too
- Upgrade us of Github API to Github App
- Use database to store and track api calls
- Add Rate limiting checks
- Enhance error handling with suitable response codes
- Create UI for checking the status
- Do more input sanity check

## License

This project is licensed under the [MIT License](LICENSE.md).